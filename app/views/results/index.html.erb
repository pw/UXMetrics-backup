<% agreementScores = [] %>
<% sortedPercent = [] %>
<% @cardtest.cards.sort_by(&:order).each do |card| %>
  <% @cardsByGroups.each do |cardIdRow| %>
    <% if card.id == JSON.parse(cardIdRow)['id'] %>
      <% countArray = [] %>
      <% titlesGrouped = JSON.parse(cardIdRow)['titles'].group_by{|i| i}.map{|k,v| [k, v.count] } %>
      <% titlesGrouped.sort_by{|k|k[1]}.reverse.each do |element| %>
        <% countArray.push(element[1]) %>
        <!-- <div><%= element[1] %></div> -->

      <% end %>
      <!-- <div><%= countArray.max %></div> -->
      <% if countArray.max == 1 %>
        <% agreementScores.push(0) %>
      <% else %>
        <% agreementScores.push(((countArray.max.to_f/countArray.sum.to_f) * 100).round(1))  %>
      <% end %>

      <% sortedPercent.push(((countArray.sum.to_f/@results.count.to_f) * 100).round(1))  %>



      <!-- <div> RATIO <%= ((countArray.max.to_f/countArray.sum.to_f) * 100).round(1) %></div> -->

      <!-- <div>-</div> -->
    <% end %>
  <% end %>
<% end %>



<div class="subhead border-t border-gray-200 bg-white">
  <div class="max-w-4xl mx-auto clearfix py-6 flex items-center px-6">
    <div class="flex-1">
      <h1 class="font-bold text-gray-600 text-xl"><%= @cardtest.name %></h1>
      <span class="text-gray-400 text-sm block">Created on <%= @cardtest.created_at.strftime("%F") %></span>
    </div>
    <div class="flex-2 text-right">
      <%= link_to "Back to overview", cardtests_url+"/"+@cardtest.uid+"/edit", class: "btn-small btn--primary" %>



    </div>
  </div>
</div>

<div class="mt-16 max-w-4xl mx-auto flex">
  <div class="w-2/3 p-4">
    <table class="table hidden">
      <thead>
        <tr>




              <th>Name</th>
              <th>Data</th>
              <th>ID</th>
              <th>Cardtest ID</th>


        </tr>
      </thead>

      <tbody>
        <% dataCompiled = [] %>
        <% @results.each do |result| %>

                <tr>


                        <td><%= result.name %></td>
                        <td><%= result.data %></td>
                        <td><%= result.id %></td>
                        <td><%= result.cardtest_id %></td>



                </tr>
                          <% dataCompiled.push(result.data.to_json)%>
                  <% end %>

            <%= javascript_tag do %>

              window.dataCompiled = <%=raw dataCompiled %>;
              window.resultGroups = <%=raw @resultgroups.to_json %>;
              window.groupsPerResult = <%=raw @groupsperresult %>;
              window.cardsByGroups = <%=raw @cardsByGroups %>;
            <% end %>

      </tbody>
    </table>

    <h4>
      <%# <%= @groupsperresult %>
      Most people created <%= @mediangroups.to_i %> group(s).
    </h4>



    <div class="bar-container mb-32"></div>






  </div>
  <div class="w-1/3 p-4">

    <div class="py-4 bg-white rounded shadow px-4 my-4">

      <p class="font-semibold px-2 text-center text-4xl text-green-600">
        <%= @results.count %>
      </p>
      <h4 class="-mt-2 font-semibold px-2 text-center">Results</h4>

    </div>
    <div class="py-4 bg-white rounded shadow px-4 my-4">

      <p class="font-semibold px-2 text-center text-4xl text-green-600">

        <% groupscount  = 0%>
        <% @resultgroups.each do |resultgroup| %>
          <% groupscount = groupscount + resultgroup.count %>
        <% end %>

        <%# <%= @resultgroups[1].count %>
        <%= groupscount %>
      </p>

      <h4 class="-mt-2 font-semibold px-2 text-center">Groups created</h4>

    </div>
    <div class="py-4 bg-white rounded shadow px-4 my-4">

      <p class="font-semibold px-2 text-center text-4xl text-green-600">
          <%= @mediantime %>
      </p>

      <h4 class="-mt-2 font-semibold px-2 text-center">Median time to complete</h4>

    </div>





  <div class="overview">




    <div class="">

    </div>

  </div>


</div>

</div>

<div class="analysis mt-16 max-w-4xl mx-auto">

  <a href="" class="">Cards analysis</a>
  <a href="" class="">Categories analysis</a>

  <table class="table text-sm" data-sortin="true">
    <thead class="uppercase text-gray-600 text-xs leading-tight font-medium">
      <th data-type="number">Card name</th>
      <th></th>
      <th>Categories</th>
      <th>Number of times</th>
      <th>Percentage of people sorted</th>
      <th>Agreement score <i class="fa fa-info-circle" aria-hidden="true"></i></th>
    </thead>
    <tbody>
      <% @cardtest.cards.sort_by(&:order).each_with_index do |card, index| %>
      <tr>
        <td><strong><%= card.name %> </strong></td>
        <td>was sorted into</td>
        <td>
          <ul>
          <% @cardsByGroups.each do |cardIdRow| %>
            <% if card.id == JSON.parse(cardIdRow)['id'] %>
              <% titlesGrouped = JSON.parse(cardIdRow)['titles'].group_by{|i| i}.map{|k,v| [k, v.count] } %>
              <% titlesGrouped.sort_by{|k|k[1]}.reverse.each do |element| %>
                <li><%= element[0] %></li>
              <% end %>
            <% end %>
          <% end %>
          </ul>
        </td>
        <td>
          <ul>
          <% @cardsByGroups.each do |cardIdRow| %>
            <% if card.id == JSON.parse(cardIdRow)['id'] %>
              <% titlesGrouped = JSON.parse(cardIdRow)['titles'].group_by{|i| i}.map{|k,v| [k, v.count] } %>
              <% titlesGrouped.sort_by{|k|k[1]}.reverse.each do |element| %>
                <li><%= element[1] %></li>
              <% end %>
            <% end %>
          <% end %>
          </ul>
        <td/>

        <%= sortedPercent[index] %>%

        <td>

          <%= agreementScores[index] %>%


        </td>
      </tr>
      <% end %>
    </tbody>

  </table>

</div>
