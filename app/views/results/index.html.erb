<% dataCompiled = [] %>

<% @results.each do |result| %>
  <% dataCompiled.push(result.data.to_json)%>
<% end %>

<%= javascript_tag do %>
  window.dataCompiled = <%=raw dataCompiled %>;
  window.groupsPerResult = <%=raw @groupsperresult %>;
<% end %>




<div class="subhead border-t border-gray-200 bg-white pl-10 pr-10">
  <div class="max-w-6xl mx-auto clearfix py-6 flex items-center px-6">
    <div class="flex-1">
      <h1 class="font-bold text-gray-600 text-xl"><%= @cardtest.name %></h1>
      <span class="text-gray-400 text-sm block">Created on <%= @cardtest.created_at.strftime("%F") %></span>
    </div>
    <div class="flex-2 text-right">
      <%= link_to "Back to overview", cardtests_url+"/"+@cardtest.uid+"/edit", class: "btn-small btn--primary" %>



    </div>
  </div>
</div>

<div class="mt-16 max-w-6xl mx-auto flex pl-10 pr-10">
  <div class="w-2/3 p-4">



    <h1 class="text-3xl mb-8">Groups created</h1>
    <h4 class="-mt-8">Most people created <%= @mediangroups.to_i %>

    <% if @mediangroups.to_i == 1%>
    group<% else %>
    groups<% end %>.</h4>
    <div id="bar-container" class="mb-32"></div>






  </div>
  <div class="w-1/3 p-4">

    <div class="py-4 bg-white rounded shadow px-4 my-4">

      <p class="font-semibold px-2 text-center text-4xl text-green-600">
        <%= @results.count %>
      </p>
      <h4 class="-mt-2 font-semibold px-2 text-center">Results</h4>

    </div>
    <div class="py-4 bg-white rounded shadow px-4 my-4">


      <p class="font-semibold px-2 text-center text-4xl text-green-600">
        <%= @titleslist.count %>
      </p>

      <h4 class="-mt-2 font-semibold px-2 text-center">Unique groups created</h4>

    </div>

    <div class="py-4 bg-white rounded shadow px-4 my-4">

      <p class="font-semibold px-2 text-center text-4xl text-green-600">
          <%= @mediantime %>
      </p>

      <h4 class="-mt-2 font-semibold px-2 text-center">Median time to complete</h4>

    </div>






</div>

</div>

<div class="analysis mt-16 mx-auto pl-10 pr-10 max-w-6xl clearfix">

  <h1 class="text-3xl mb-8 float-left">Detailed analysis</h1>

  <div class="table-tabs text-center mb-8 float-right">
    <a href="" class="font-semibold active mr-3">View cards</a>
    <a href="" class="font-semibold ml-3">View groups</a>
  </div>

  <table data-page-size="5000" data-paging="false" class="table text-sm cards-table">
    <thead class="uppercase text-gray-900 text-xs leading-tight font-medium">
      <tr>
        <th data-type="text" data-sort-initial="true">Card name</th>
        <th data-sort-ignore="true" width="200">Sorted into</th>
        <th data-sort-ignore="true" width="100"></th>
        <th data-type="numeric">Percentage of people sorted</th>
        <th data-type="numberic">Agreement score
          <!-- <i class="fa fa-info-circle" aria-hidden="true"></i> -->
        </th>
      </tr>
    </thead>
    <tbody>


      <% pp "all cards below:" %>
      <% pp @cardsByGroups %>
      <% @cardsByGroups.each do |cardIdRow| %>
        <tr>


          <% pp "name:" %>
          <td>


            <% pp "single card below:" %>
            <% pp cardIdRow %>
            <h3><%= JSON.parse(cardIdRow)["name"] %></h3></td>
          <% pp "done" %>
          <td>


            <% titlesGroups = JSON.parse(cardIdRow)['titles'].partition{|v| v == "Unnamed"}
              # Separating titles into Unnamed and NOT, because we want Unnamed at the bottom and not grouped
              if titlesGroups.count == 2
                unnamedList = titlesGroups[0]
                titlesGroups[0] = titlesGroups[0].map{|k,v| [k, 1] }
                titlesGroups[1] = titlesGroups[1].group_by{|i| i}.map{|k,v| [k, v.count]}
                groups = titlesGroups[1].sort_by{|k|k[1]}.reverse + titlesGroups[0]
                # puts titlesGroups[1]
                # puts titlesGroups[0]
              else
                groups = titlesGroups[0].sort_by{|k|k[1]}.reverse
              end
            %>
            <ul class="categories-list">
              <%# <% JSON.parse(cardIdRow)["titles"].each do |group| %>
              <%# <% titlesGrouped = JSON.parse(cardIdRow)['titles'].group_by{|i| i}.map{|k,v| [k, v.count] } %>

              <%# <% titlesGrouped = JSON.parse(cardIdRow)['titles'].group_by{|i| i}.select{|title|title !='Unnamed'}.map{|k,v| [k, v.count] } %>

              <%# titlesGrouped %>
              <% groups.each do |element| %>
                <li><%= element[0] %>

                </li>

              <% end %>

            </ul>
          </td>
          <td>
            <% titlesGroups = JSON.parse(cardIdRow)['titles'].partition{|v| v == "Unnamed"}
              # Separating titles into Unnamed and NOT, because we want Unnamed at the bottom and not grouped
              if titlesGroups.count == 2
                unnamedList = titlesGroups[0]
                titlesGroups[0] = titlesGroups[0].map{|k,v| [k, 1] }
                titlesGroups[1] = titlesGroups[1].group_by{|i| i}.map{|k,v| [k, v.count]}
                groups = titlesGroups[1].sort_by{|k|k[1]}.reverse + titlesGroups[0]
                # puts titlesGroups[1]
                # puts titlesGroups[0]
              else
                groups = titlesGroups[0].sort_by{|k|k[1]}.reverse
              end
            %>
            <ul class="counts-list">
              <% groups.each do |element| %>
              <li><%= element[1] %>
                <% if element[1] == 1 %>
                  time
                <% else %>
                  times
                <% end %></li>
              <% end %>
            </ul>
          </td>
          <td data-sort-value="<%= JSON.parse(cardIdRow)['sortedpercent']*100 %>">
            <%= JSON.parse(cardIdRow)['sortedpercent'] %>%
          </td>
          <td data-sort-value="<%= JSON.parse(cardIdRow)['agreementscore'] %>">
            <%= JSON.parse(cardIdRow)['agreementscore'] %>%
          </td>
        </tr>
      <% end %>
    </tbody>

  </table>
  <% uniqueTitles = [] %>
  <% finalTitles = [] %>


  <% puts "resultgroups count: "+ @resultgroups.count.to_s %>









  <%# puts @titleslist %>


  <table data-page-size="5000" data-paging="false" class="table text-sm categories-table hidden">
    <thead class="uppercase text-gray-900 text-xs leading-tight font-medium">
      <tr>
        <th data-type="text" data-sort-initial="true" width="200">Group name</th>
        <th data-type="numeric">Created by</th>
        <th data-sort-ignore="true">Cards added</th>
        <th data-type="numeric">Number of times</th>


      </tr>
    </thead>
    <tbody>
      <%# Create json data for relationship graph %>


      <% @linksList = Array.new %>




      <% @titleslist.each do |title| %>
      <%# <% @titlesList.each_with_index do |title, index| %>
          <tr>
            <td><%= title[:title] %></td>










            <td data-sort-value="<%= title[:createdby] %>">
              <% if title[:createdby] > 1%>
                <%= title[:createdby] %> respondents
              <% else %>
                <%= title[:createdby] %> respondent
              <% end %>
            </td>
            <td>
              <ul>

              <% title[:cards].each do |card| %>

                <%# add cards to nodesList%>
                <%# <% @nodesList.push({:name => @cardtest.cards.find(card[0]).name}) %>
                <% @linksList.push([title[:title], @cardtest.cards.find(card[0]).name, card[1], "<div class='p-2'><strong>"+@cardtest.cards.find(card[0]).name+"</strong>" + " grouped into <strong>"+title[:title]+"</strong><br/><br/> <strong>"+ card[1].to_s + "</strong> time(s)</div>" ]) %>
                <%# <% @linksList.push({:source => groupIndex, :target => i, :value => card[1]}) %>

                <li><%= @cardtest.cards.find(card[0]).name %></li>
              <% end %>
            </ul>
            </td>
            <td>
              <ul>
                <% title[:cards].each do |card| %>
                  <li>
                    <% if card[1] > 1 %>
                      <%= card[1] %> times</li>
                    <% else %>
                      <%= card[1] %> time</li>
                    <% end %>


                <% end %>
              </ul>
            </td>


          </tr>



      <% end %>
    </tbody>
  </table>

  <%


  %>


  <%= javascript_tag do %>
    window.relationshipData = <%= raw @linksList %>;
  <% end %>



</div>
<div class="analysis mt-16 mx-auto pl-10 pr-10 max-w-6xl clearfix">
  <h1 class="text-3xl mb-8">Grouping visualization</h1>
  <div id="sankey" class="mb-12">
  </div>
</div>
