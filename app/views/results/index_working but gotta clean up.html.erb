<% agreementScores = [] %>
<% sortedPercent = [] %>
<% @cardtest.cards.sort_by(&:order).each do |card| %>
  <% @cardsByGroups.each do |cardIdRow| %>
    <% if card.id == JSON.parse(cardIdRow)['id'] %>
      <% countArray = [] %>
      <% titlesGrouped = JSON.parse(cardIdRow)['titles'].group_by{|i| i}.map{|k,v| [k, v.count] } %>
      <% titlesGrouped.sort_by{|k|k[1]}.reverse.each do |element| %>
        <% countArray.push(element[1]) %>
        <!-- <div><%= element[1] %></div> -->

      <% end %>
      <!-- <div><%= countArray.max %></div> -->
      <% if countArray.max == 1 %>
        <% agreementScores.push(0) %>
      <% else %>
        <% agreementScores.push(((countArray.max.to_f/countArray.sum.to_f) * 100).round(1))  %>
      <% end %>

      <% sortedPercent.push(((countArray.sum.to_f/@results.count.to_f) * 100).round(1))  %>



      <!-- <div> RATIO <%= ((countArray.max.to_f/countArray.sum.to_f) * 100).round(1) %></div> -->

      <!-- <div>-</div> -->
    <% end %>
  <% end %>
<% end %>

<% uniqueCategories = [] %>
<% categories = [] %>


<div class="subhead border-t border-gray-200 bg-white pl-10 pr-10">
  <div class="max-w-6xl mx-auto clearfix py-6 flex items-center px-6">
    <div class="flex-1">
      <h1 class="font-bold text-gray-600 text-xl"><%= @cardtest.name %></h1>
      <span class="text-gray-400 text-sm block">Created on <%= @cardtest.created_at.strftime("%F") %></span>
    </div>
    <div class="flex-2 text-right">
      <%= link_to "Back to overview", cardtests_url+"/"+@cardtest.uid+"/edit", class: "btn-small btn--primary" %>



    </div>
  </div>
</div>

<div class="mt-16 max-w-6xl mx-auto flex pl-10 pr-10">
  <div class="w-2/3 p-4">

    <h4>Cards by groups</h4>

    <ul>
    <% @cardsByGroups.each do |cardIdRow| %>
      <li><%= cardIdRow %></li>
    <% end %>
    </ul>

    <h5>Cards count:</h5>
    <%= @cardsByGroups.count %>

    <br/><br/><br/><br/>

    <h4>Result groups</h4>

    <ul>
    <% @resultgroups.each do |cardIdRow| %>
      <li><%= cardIdRow %></li>
    <% end %>
    </ul>

    <h5>Result count:</h5>
    <%= @resultgroups.count %>




    <h1 class="text-3xl mb-4">Overview</h1>
    <h4>
      <%# <%= @groupsperresult %>
      Most people created <%= @mediangroups.to_i %>

      <% if @mediangroups.to_i == 1%>
      group<% else %>
      groups<% end %>.
    </h4>



    <div class="bar-container mb-32"></div>






  </div>
  <div class="w-1/3 p-4">

    <div class="py-4 bg-white rounded shadow px-4 my-4">

      <p class="font-semibold px-2 text-center text-4xl text-green-600">
        <%= @results.count %>
      </p>
      <h4 class="-mt-2 font-semibold px-2 text-center">Results</h4>

    </div>
    <div class="py-4 bg-white rounded shadow px-4 my-4">


      <p class="font-semibold px-2 text-center text-4xl text-green-600">

        <% groupscount  = 0%>

        <!-- <h4><%= @resultgroups.uniq %></h4> -->

        <% @resultgroups.each do |resultgroup| %>


          <% if resultgroup.count > 0%>
            <% resultgroup.each do |result| %>
              <% if result["card"].length > 0 %>
                <% categories.push(result["title"]) %>
              <% end %>
            <% end %>
          <% end %>
          <%# <% unless uniqueCategories.include?(resultgroup)
            uniqueCategories << resultgroup
          end
          groupscount = groupscount + resultgroup.count %>
        <% end %>



        <% categories.map!(&:capitalize).each do |category| %>
          <% if category != "Unnamed" %>
            <% if !uniqueCategories.include?(category) %>
              <% uniqueCategories.push(category) %>
            <% end %>
          <% else %>
            <% uniqueCategories.push(category) %>
          <% end %>


        <% end %>


      <%= uniqueCategories.count %></p>

      <h4 class="-mt-2 font-semibold px-2 text-center">Groups created</h4>

    </div>

    <div class="py-4 bg-white rounded shadow px-4 my-4">

      <p class="font-semibold px-2 text-center text-4xl text-green-600">
          <%= @mediantime %>
      </p>

      <h4 class="-mt-2 font-semibold px-2 text-center">Median time to complete</h4>

    </div>






</div>

</div>

<div class="analysis mt-16 mx-auto pl-10 pr-10 max-w-6xl clearfix">

  <h1 class="text-3xl mb-8 float-left">Detailed analysis</h1>

  <div class="table-tabs text-center mb-8 float-right">
    <a href="" class="font-semibold active mr-3">View cards</a>
    <a href="" class="font-semibold ml-3">View groups</a>
  </div>
  <table data-page-size="5000" data-paging="false" class="table text-sm cards-table">
    <thead class="uppercase text-gray-900 text-xs leading-tight font-medium">
      <tr>
        <th data-type="text" data-sort-initial="true">Card name</th>
        <th data-sort-ignore="true" width="200">Sorted into</th>
        <th data-sort-ignore="true" width="100"></th>
        <th data-type="numeric">Percentage of people sorted</th>
        <th data-type="numberic">Agreement score
          <!-- <i class="fa fa-info-circle" aria-hidden="true"></i> -->
        </th>
      </tr>
    </thead>
    <tbody>
      <% @cardtest.cards.sort_by(&:order).each_with_index do |card, index| %>
      <tr>
        <td><h3><%= card.name %> </h3></td>

        <td>
          <ul class="categories-list">
          <% @cardsByGroups.each do |cardIdRow| %>
            <% if card.id == JSON.parse(cardIdRow)['id'] %>
              <% titlesGrouped = JSON.parse(cardIdRow)['titles'].group_by{|i| i}.map{|k,v| [k, v.count] } %>
              <% titlesGrouped.sort_by{|k|k[1]}.reverse.each do |element| %>
                <%# <% uniqueCategories.push(element[0]) %>
                <li><%= element[0] %></li>
              <% end %>
            <% end %>
          <% end %>
          </ul>
        </td>
        <td>
          <ul class="counts-list">
          <% @cardsByGroups.each do |cardIdRow| %>
            <% if card.id == JSON.parse(cardIdRow)['id'] %>
              <% titlesGrouped = JSON.parse(cardIdRow)['titles'].group_by{|i| i}.map{|k,v| [k, v.count] } %>
              <% titlesGrouped.sort_by{|k|k[1]}.reverse.each do |element| %>
                <li><%= element[1] %>
                  <% if element[1] == 1 %>
                    time
                  <% else %>
                    times
                  <% end %></li>
              <% end %>
            <% end %>
          <% end %>
          </ul>
        </td>
        <td data-sort-value="<%= sortedPercent[index]*100 %>">
          <%= sortedPercent[index] %>%
        </td>
        <td data-sort-value="<%= agreementScores[index] %>">

          <%= agreementScores[index] %>%


        </td>
      </tr>
      <% end %>
    </tbody>

  </table>

  <table data-page-size="5000" data-paging="false" class="table text-sm categories-table hidden">
    <thead class="uppercase text-gray-900 text-xs leading-tight font-medium">
      <tr>
        <th data-type="text" data-sort-initial="true">Group name</th>
        <th data-sort-ignore="true" width="200">Cards added</th>
        <th data-sort-ignore="true" width="100"></th>
        <th data-type="numeric">Percentage of people sorted</th>
        <th data-type="numberic">Agreement score
          <!-- <i class="fa fa-info-circle" aria-hidden="true"></i> -->
        </th>
      </tr>
    </thead>
    <tbody>
      <% uniqueCategories.each do |category| %>
      <tr>
        <td><%= category %></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
      </tr>
      <% end %>
    </tbody>
  </table>

</div>
